#!/bin/bash

if [ -z "$1" ]; then
  echo "âŒ Báº¡n cáº§n truyá»n Ä‘Æ°á»ng dáº«n thÆ° má»¥c cáº§n quÃ©t."
  echo "âœ… CÃ¡ch dÃ¹ng: ./scan-malware.sh /duong/dan/thu-muc"
  exit 1
fi

PROJECT_DIR="$1"
TIMESTAMP=$(date +%F_%H%M%S)
CSV_REPORT="./malware_scan_$TIMESTAMP.csv"

echo "ðŸ” Äang quÃ©t mÃ£ Ä‘á»™c táº¡i: $PROJECT_DIR"
echo "ðŸ“ Xuáº¥t káº¿t quáº£ CSV: $CSV_REPORT"
echo "-------------------------------------------"

# Ghi tiÃªu Ä‘á» CSV
echo "File,Line Number,Matched Pattern,Content" > "$CSV_REPORT"

# CÃ¡c pattern nghi ngá»
patterns=(
  'eval *\('
  'base64_decode *\('
  'gzinflate *\('
  'file_get_contents *\(["'\'']http'
  'shell_exec *\('
  'system *\('
  'passthru *\('
  'preg_replace *\([^\)]*/e'
  'kuemeranti'
)

# Danh sÃ¡ch file nghi ngá»
declare -A infected_files

# Báº¯t Ä‘áº§u quÃ©t
find "$PROJECT_DIR" -type f -name "*.php" | while read -r file; do
  lineno=0
  while IFS= read -r line || [ -n "$line" ]; do
    lineno=$((lineno + 1))
    for pattern in "${patterns[@]}"; do
      if [[ "$line" =~ $pattern ]]; then
        echo "âš ï¸  $file:$lineno â†’ $pattern"
        echo "\"$file\",$lineno,\"$pattern\",\"$(echo "$line" | sed 's/\"/""/g')\"" >> "$CSV_REPORT"
        infected_files["$file"]=1
        break
      fi
    done
  done < "$file"
done

echo
echo "ðŸ“‚ Danh sÃ¡ch file nghi ngá»:"
echo "----------------------------"
for f in "${!infected_files[@]}"; do
  echo "âš ï¸  $f"
done

echo
echo "âœ… HoÃ n táº¥t. Káº¿t quáº£ lÆ°u táº¡i: $CSV_REPORT"
